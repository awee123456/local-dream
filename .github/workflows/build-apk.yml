name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential python3-pip dos2unix
          pip3 install gdown

      - name: Install Rust
        run: |
          rustup default 1.84.0
          rustup target add aarch64-linux-android

      - name: Download QNN SDK
        run: |
          # ใช้ลิงก์จากเอกสารที่ผู้ใช้ให้มา
          wget -O qnn_sdk.zip "https://apigwx-aws.qualcomm.com/qsc/public/v1/api/download/software/sdks/Qualcomm_AI_Runtime_Community/All/2.39.0.250926/v2.39.0.250926.zip"
          unzip qnn_sdk.zip -d qnn_sdk_dir
          # หาโฟลเดอร์ที่แท้จริงหลังแตกไฟล์
          echo "QNN_SDK_ROOT=$(pwd)/qnn_sdk_dir/$(ls qnn_sdk_dir)" >> $GITHUB_ENV

      - name: Build Native Libraries
        run: |
          cd app/src/main/cpp/
          
          # ค้นหาตำแหน่ง NDK ที่ติดตั้งมากับ runner
          export NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls $ANDROID_SDK_ROOT/ndk | sort -V | tail -1)
          echo "Using NDK at: $NDK_PATH"
          
          # อัปเดต Path ในไฟล์กำหนดค่า
          sed -i "s|/data/android-ndk-r28|$NDK_PATH|g" CMakePresets.json
          sed -i "s|/data/qairt/2.39.0.250926|${{ env.QNN_SDK_ROOT }}|g" CMakeLists.txt
          
          dos2unix build.sh
          chmod +x build.sh
          
          export ANDROID_NDK_ROOT=$NDK_PATH
          export QNN_SDK_ROOT=${{ env.QNN_SDK_ROOT }}
          
          # รันสคริปต์บิลด์
          ./build.sh

      - name: Build APK
        run: |
          # สร้าง debug APK เพื่อหลีกเลี่ยงปัญหาเรื่อง signing key ในเบื้องต้น
          # หรือถ้าต้องการ release ต้องใช้ dummy keystore
          ./gradlew assembleBasicDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: LocalDream-Debug-APK
          path: app/build/outputs/apk/basic/debug/*.apk
