name: Build Android APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential dos2unix ccache

    - name: Install Rust
      run: |
        rustup default 1.84.0
        rustup target add aarch64-linux-android

    - name: Cache QNN SDK
      id: cache-qnn
      uses: actions/cache@v4
      with:
        path: qnn_sdk_extracted
        key: qnn-sdk-2.39.0.250926

    - name: Download and Setup QNN SDK
      if: steps.cache-qnn.outputs.cache-hit != 'true'
      run: |
        wget -O qnn_sdk.zip "https://apigwx-aws.qualcomm.com/qsc/public/v1/api/download/software/sdks/Qualcomm_AI_Runtime_Community/All/2.39.0.250926/v2.39.0.250926.zip"
        unzip qnn_sdk.zip -d qnn_sdk_extracted

    - name: Set QNN Path
      run: |
        QNN_PATH=$(pwd)/$(find qnn_sdk_extracted -maxdepth 2 -type d -name "2.39.*" | head -n 1)
        echo "QNN_SDK_ROOT=$QNN_PATH" >> $GITHUB_ENV

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-ccache

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r28
        add-to-path: false

    - name: Update Version Code and Name
      run: |
        # Auto versioning based on run number
        VERSION_CODE=${{ github.run_number }}
        VERSION_NAME="2.3.1-build${{ github.run_number }}"
        sed -i "s/versionCode = .*/versionCode = $VERSION_CODE/" app/build.gradle.kts
        sed -i "s/versionName = .*/versionName = \"$VERSION_NAME\"/" app/build.gradle.kts
        echo "Version set to $VERSION_NAME ($VERSION_CODE)"

    - name: Run Android Lint
      run: |
        chmod +x gradlew
        ./gradlew lintBasicDebug

    - name: Update Paths and Build Native Libraries
      env:
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        cd app/src/main/cpp
        sed -i "s|set(QNN_SDK_ROOT .*)|set(QNN_SDK_ROOT ${{ env.QNN_SDK_ROOT }})|g" CMakeLists.txt
        sed -i "s|\"/data/android-ndk-r28\"|\"${{ steps.setup-ndk.outputs.ndk-path }}\"|g" CMakePresets.json
        dos2unix build.sh
        chmod +x build.sh
        export ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}
        export QNN_SDK_ROOT=${{ env.QNN_SDK_ROOT }}
        ./build.sh

    - name: Build APK
      run: |
        ./gradlew assembleBasicDebug

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LocalDream-v2.3.1-build${{ github.run_number }}
        path: app/build/outputs/apk/basic/debug/*.apk

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: app/build/outputs/apk/basic/debug/*.apk
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
