name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build build-essential dos2unix ccache

    - name: Install Rust
      run: |
        rustup default 1.84.0
        rustup target add aarch64-linux-android

    - name: Download and Setup QNN SDK
      run: |
        # Download QNN SDK 2.39 from the provided link
        wget -O qnn_sdk.zip "https://apigwx-aws.qualcomm.com/qsc/public/v1/api/download/software/sdks/Qualcomm_AI_Runtime_Community/All/2.39.0.250926/v2.39.0.250926.zip"
        unzip qnn_sdk.zip -d qnn_sdk_extracted
        # Find the actual SDK directory (it might be nested)
        QNN_PATH=$(pwd)/$(find qnn_sdk_extracted -maxdepth 2 -type d -name "2.39.*" | head -n 1)
        echo "QNN_SDK_ROOT=$QNN_PATH" >> $GITHUB_ENV
        echo "QNN_SDK_ROOT is $QNN_PATH"

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r28
        add-to-path: false

    - name: Update Paths and Build Native Libraries
      env:
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        cd app/src/main/cpp
        
        # Update QNN_SDK_ROOT in CMakeLists.txt
        sed -i "s|set(QNN_SDK_ROOT .*)|set(QNN_SDK_ROOT ${{ env.QNN_SDK_ROOT }})|g" CMakeLists.txt
        
        # Update ANDROID_NDK_ROOT in CMakePresets.json (both in environment and cacheVariables)
        # Use a different delimiter for sed to avoid issues with paths
        sed -i "s|\"/data/android-ndk-r28\"|\"${{ steps.setup-ndk.outputs.ndk-path }}\"|g" CMakePresets.json
        
        # Ensure build.sh is executable and has correct line endings
        dos2unix build.sh
        chmod +x build.sh
        
        # Run build script with explicit environment variables
        export ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}
        export QNN_SDK_ROOT=${{ env.QNN_SDK_ROOT }}
        ./build.sh

    - name: Build APK
      run: |
        chmod +x gradlew
        # Build basicDebug to avoid signing issues for now
        ./gradlew assembleBasicDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: LocalDream-Debug-APK
        path: app/build/outputs/apk/basic/debug/*.apk
