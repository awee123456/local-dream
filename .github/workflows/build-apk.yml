name: Build Android APK (AI Engine Ready)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. โคลนโปรเจกต์พร้อม Submodules (สำคัญมากสำหรับเครื่องยนต์ AI)
      - name: Checkout Repository (Recursive)
        uses: actions/checkout@v4
        with:
          repository: xororz/local-dream
          submodules: recursive
          token: ${{ secrets.GH_TOKEN }}

      # 2. เคลียร์พื้นที่เพื่อให้แตกไฟล์ SDK 1.35GB ได้
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost"

      # 3. ติดตั้งเครื่องมือตามคู่มือ (Rust 1.84.0, Ninja, CMake, dos2unix)
      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential python3-pip dos2unix
          pip3 install gdown

      - name: Set up Rust 1.84.0
        run: |
          rustup toolchain install 1.84.0
          rustup default 1.84.0
          rustup target add aarch64-linux-android

      # 4. ดาวน์โหลดและเตรียม QNN SDK 2.39
      - name: Download QNN SDK
        run: |
          gdown 1vp9rvm9lriSnbrRg9tgJx4pLgdqQ60Dn -O qnn_sdk.zip
          unzip -q qnn_sdk.zip -d qnn_sdk_extracted
          rm qnn_sdk.zip
          QNN_ROOT=$(find $(pwd)/qnn_sdk_extracted -name "lib" -type d | head -n 1 | xargs dirname)
          echo "QNN_SDK_ROOT=$QNN_ROOT" >> $GITHUB_ENV

      # 5. ตั้งค่า Path ให้ตรงตามคู่มือ Step 2
      - name: Configure SDK & NDK Paths
        run: |
          # หาตำแหน่ง NDK ในระบบ GitHub
          export NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls $ANDROID_SDK_ROOT/ndk | sort -V | tail -1)
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          
          # เขียนค่าลงใน CMakeLists.txt ของโปรเจกต์
          sed -i "s|set(QNN_SDK_ROOT .*)|set(QNN_SDK_ROOT \"${{ env.QNN_SDK_ROOT }}\")|g" app/src/main/cpp/CMakeLists.txt

      # 6. รันการ Build เครื่องยนต์ AI (Step 3: build.sh)
      - name: Build Native Libraries (The AI Engine)
        run: |
          cd app/src/main/cpp/
          
          # แก้ไขปัญหา CMake Policy ที่เคยเจอใน Log ก่อนหน้า
          sed -i 's/cmake_minimum_required(VERSION [0-9.]*)/cmake_minimum_required(VERSION 3.10)/g' 3rdparty/tokenizers-cpp/sentencepiece/CMakeLists.txt
          
          # เตรียมสคริปต์และรัน
          dos2unix build.sh
          chmod +x build.sh
          
          export ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }}
          export QNN_SDK_ROOT=${{ env.QNN_SDK_ROOT }}
          
          # รันสคริปต์คอมไพล์หลักตามคู่มือ
          bash ./build.sh

      # 7. สร้างไฟล์ APK (Step 4)
      - name: Build Android APK
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      # 8. อัปโหลดผลลัพธ์
      - name: Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: Local-Dream-AI-Ready
          path: app/build/outputs/apk/**/*.apk
