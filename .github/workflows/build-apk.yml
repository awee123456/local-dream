name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      QNN_VERSION: 2.39.0.250926
      RUST_VERSION: 1.84.0

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake ninja-build build-essential dos2unix ccache unzip

    # ---------- Rust ----------
    - name: Install Rust toolchain
      run: |
        rustup toolchain install ${RUST_VERSION}
        rustup default ${RUST_VERSION}
        rustup target add aarch64-linux-android

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo
          target
        key: cargo-${{ runner.os }}-${{ env.RUST_VERSION }}

    # ---------- QNN SDK ----------
    - name: Cache QNN SDK
      id: cache-qnn
      uses: actions/cache@v4
      with:
        path: qnn_sdk
        key: qnn-${{ env.QNN_VERSION }}

    - name: Download QNN SDK
      if: steps.cache-qnn.outputs.cache-hit != 'true'
      run: |
        wget -O qnn_sdk.zip "https://apigwx-aws.qualcomm.com/qsc/public/v1/api/download/software/sdks/Qualcomm_AI_Runtime_Community/All/${QNN_VERSION}/v${QNN_VERSION}.zip"
        unzip qnn_sdk.zip
        mv */2.39.* qnn_sdk

    - name: Export QNN_SDK_ROOT
      run: echo "QNN_SDK_ROOT=${{ github.workspace }}/qnn_sdk" >> $GITHUB_ENV

    # ---------- Android NDK ----------
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r28
        add-to-path: false

    - name: Cache Android NDK
      uses: actions/cache@v4
      with:
        path: ${{ steps.setup-ndk.outputs.ndk-path }}
        key: ndk-r28-${{ runner.os }}

    # ---------- Native build ----------
    - name: Build Native Libraries
      env:
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        cd app/src/main/cpp
        dos2unix build.sh
        chmod +x build.sh
        ./build.sh

    # ---------- Gradle ----------
    - name: Build APK
      run: |
        chmod +x gradlew
        ./gradlew assembleBasicDebug --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: LocalDream-Debug-APK
        path: app/build/outputs/apk/basic/debug/*.apk
